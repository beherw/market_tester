import{_ as gt,l as Ht,g as Qe,a as qr}from"./services-data-DOFC0cEd.js";import{u as Rr,b as Er,a as Mr,r as s,d as Ke,j as t}from"./react-vendor-DmEpS5Kz.js";import{g as Mt,T as Lr,a as $r,S as Dr,b as Ar,c as Br}from"./index-CDnSI-_z.js";import{d as Tr,j as _r}from"./data-tw-other-De0qaQHL.js";import{t as mt}from"./data-tw-items-4ChDDRSh.js";import"./opencc-C1Qz6KEM.js";import"./data-tw-descriptions-CJIEoqIq.js";import"./vendor-dPMYpV4t.js";import"./axios-B9ygI19o.js";function Zr({addToast:K,removeToast:Ot,toasts:Qt,datacenters:Kt,worlds:pt,selectedWorld:O,onWorldChange:Zt,selectedServerOption:G,onServerOptionChange:Xt,serverOptions:Yt,isServerDataLoaded:ze,onItemSelect:xt,onSearch:er,searchText:tr,setSearchText:lt,isSearching:Z,onTaxRatesClick:rr,isTaxRatesModalOpen:nr,setIsTaxRatesModalOpen:lr,taxRates:sr,isLoadingTaxRates:or}){const bt=Rr(),[Lt]=Er(),Ze=Mr(),[Y,vt]=s.useState("filter"),yt=!0,[$t,ar]=s.useState(""),[le,ee]=s.useState([]),[ue,fe]=s.useState([]),[je,pe]=s.useState(!1),wt=s.useRef(!1),It=s.useRef(""),[ir,Me]=s.useState({}),[cr,Le]=s.useState({}),[dr,$e]=s.useState({}),[ur,De]=s.useState({}),[Ct,xe]=s.useState({}),[Pe,X]=s.useState(!1),[Dt,St]=s.useState(null),[Nt,Fr]=s.useState(!1),[Je,Ae]=s.useState(null),st=500,[fr,Vr]=s.useState(!0),[F,At]=s.useState([]),[te,Bt]=s.useState([]),[U,z]=s.useState(!1),[Be,hr]=s.useState(new Set),[be,We]=s.useState(1),[ve,Ge]=s.useState(999),[gr,Tt]=s.useState(!1),[mr,_t]=s.useState(!1),[He,jt]=s.useState(""),[ke,pr]=s.useState(!0),[Te,Pt]=s.useState(""),kt=[62],[L,he]=s.useState(1),[ye,Ft]=s.useState(50),[xr,Xe]=s.useState(!1),Oe=s.useRef(null),_e=s.useCallback(e=>{hr(r=>new Set(r).add(e))},[]),H=s.useRef(null),J=s.useRef(0),qe=s.useRef(!1),[ot,Re]=s.useState(!1),g=s.useRef(0);s.useRef(0);const[Ye,et]=s.useState(!1),qt=s.useRef(null),at=s.useRef(null),it=s.useCallback(async()=>{if(at.current)return at.current;const e=await gt(()=>import("./data-other-BAzrwk9S.js").then(r=>r.c),[]);return at.current=e.default,at.current},[]),ct=s.useRef(null),[we,br]=s.useState(null),[tt,Rt]=s.useState([]),Vt=s.useCallback(async()=>{if(ct.current)return ct.current;const e=await gt(()=>import("./data-other-BAzrwk9S.js").then(r=>r.r),[]);return ct.current=e.default,ct.current},[]);s.useEffect(()=>{Vt().then(e=>{br(e)})},[Vt]),s.useEffect(()=>{he(1)},[tt]),s.useEffect(()=>{if(le.length>0||ue.length>0){const r=Math.ceil((je?ue:le).length/ye);r>0&&L>r&&he(1)}},[le.length,ue.length,je,ye,L]);const dt=s.useRef(null),ut=s.useCallback(async()=>{if(dt.current)return dt.current;const e=await gt(()=>import("./data-other-BAzrwk9S.js").then(r=>r.o),[]);return dt.current=e.default,dt.current},[]),ft=s.useRef(null),Ut=s.useCallback(async()=>{if(ft.current)return ft.current;const e=await gt(()=>import("./data-other-BAzrwk9S.js").then(r=>r.u),[]);return ft.current=e.default,ft.current},[]),rt=s.useCallback(e=>({1:"GLA",2:"PGL",3:"MRD",4:"LNC",5:"ARC",6:"CNJ",7:"THM",8:"CRP",9:"BSM",10:"ARM",11:"GSM",12:"LTW",13:"WVR",14:"ALC",15:"CUL",16:"MIN",17:"BTN",18:"FSH",19:"PLD",20:"MNK",21:"WAR",22:"DRG",23:"BRD",24:"WHM",25:"BLM",26:"ACN",27:"SMN",28:"SCH",29:"ROG",30:"NIN",31:"MCH",32:"DRK",33:"AST",34:"SAM",35:"RDM",36:"BLU",37:"GNB",38:"DNC",39:"RPR",40:"SGE",41:"VPR",42:"PCT"})[e],[]);s.useCallback(async(e=null)=>{{K("批量搜索功能暂时不可用，敬请期待","info");return}},[$t,O,G,K,Ye,fr]),s.useEffect(()=>{if(!ze)return;const e=`${Ze.pathname}?${Ze.search}`;if(It.current===e)return;if(Ze.pathname!=="/advanced-search"){It.current=e;return}const r=Lt.get("q");r&&r.trim()!==""?(Y==="batch"&&vt("filter"),wt.current=!1):(wt.current&&le.length>0&&(ee([]),Me({}),Le({}),$e({}),De({}),xe({}),he(1)),wt.current=!1),It.current=e},[Ze.pathname,Ze.search,Lt,ze,$t,Y,le.length,Nt,U,Z]),s.useEffect(()=>{Y==="batch"&&vt("filter")},[Y]),s.useEffect(()=>{if((Pe||U||ot)&&((Y==="filter"&&je?ue:le).length>=50||le.length>=50||ue.length>=50))Oe.current||(Oe.current=Date.now()),Xe(!0);else if(Oe.current){const k=Date.now()-Oe.current,u=Math.max(0,1e3-k);if(u>0){const M=setTimeout(()=>{Xe(!1),Oe.current=null},u);return()=>clearTimeout(M)}else Xe(!1),Oe.current=null}else Xe(!1)},[Pe,U,ot,je,le.length,ue.length,Y]);const{craftingJobs:vr,gatheringJobs:yr,battleJobsByRole:ge}=s.useMemo(()=>{const e=new Set([1,2,3,4,5,6,7,26,29]),r={19:"tank",21:"tank",32:"tank",37:"tank",24:"healer",28:"healer",33:"healer",40:"healer",20:"melee",22:"melee",30:"melee",34:"melee",39:"melee",41:"melee",23:"ranged",31:"ranged",38:"ranged",25:"caster",27:"caster",35:"caster",36:"caster",42:"caster"},k=y=>`https://garlandtools.org/files/icons/job/${y}.png`,u=[],M=[],q={tank:[],healer:[],melee:[],ranged:[],caster:[]};return Object.entries(Tr).forEach(([y,w])=>{const N=parseInt(y,10);if(e.has(N))return;const i=rt(N);if(!i)return;const l=r[N];let c=null;l==="tank"?c="#2d3a80":l==="healer"?c="#346624":(l==="melee"||l==="ranged"||l==="caster")&&(c="#732828");let n=c;N>=8&&N<=18&&(n="#4a5568");const o={id:N,name:w.tw,iconUrl:k(i),roleColor:n};N>=8&&N<=15?u.push(o):N>=16&&N<=18?M.push(o):N>=19&&N<=42&&l&&q[l]&&q[l].push(o)}),u.sort((y,w)=>y.id-w.id),M.sort((y,w)=>y.id-w.id),Object.keys(q).forEach(y=>{q[y].sort((w,N)=>w.id-N.id)}),{craftingJobs:u,gatheringJobs:M,battleJobsByRole:q}},[rt]),wr=new Set([1,2,3,4,5,6,7,8,9,10,84,87,88,89,96,97,98,105,106,107,108,109,110,111]),Ir=new Set([12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,99]),Cr={19:[2],20:[1],21:[3],22:[5],23:[4],24:[8,9],25:[6,7],27:[10],28:[10,98],30:[84],31:[88],32:[2,87],33:[89],34:[96],35:[97],36:[105],37:[106],38:[107],39:[108],40:[109],41:[110],42:[111]},Sr={8:12,9:14,10:16,11:18,12:20,13:22,14:24,15:26},Nr={8:13,9:15,10:17,11:19,12:21,13:23,14:25,15:27},jr={19:11},Pr={16:28,17:30,18:32},kr={16:29,17:31,18:99},zt={主武器:[1,2,3,4,5,6,7,8,9,10,84,87,88,89,96,97,98,105,106,107,108,109,110,111,12,14,16,18,20,22,24,26,28,30,32],副手武器:[11,13,15,17,19,21,23,25,27,29,31,33,99]},Jt=new Set([34,35,36,37,38,40,41,42,43,62]),Fe=s.useMemo(()=>{const e=Object.entries(_r).map(([l,c])=>({id:parseInt(l,10),name:c.tw})).filter(l=>!wr.has(l.id)&&!Ir.has(l.id)&&!kt.includes(l.id)),r=e.filter(l=>Jt.has(l.id)),k=e.filter(l=>!Jt.has(l.id)&&l.id!==11),u=[34,35,37,36,38,41,40,42,43,62];r.sort((l,c)=>{const n=u.indexOf(l.id),o=u.indexOf(c.id);return n!==-1&&o!==-1?n-o:n!==-1?-1:o!==-1?1:l.id-c.id}),k.sort((l,c)=>l.id===39?1:c.id===39?-1:l.id-c.id);const M=[{id:"main_weapon",name:"主手",isGeneric:!0},{id:"offhand_weapon",name:"副手",isGeneric:!0}],q=[34,35,37,36,38],y=[41,40,42,43],w=r.filter(l=>q.includes(l.id)),N=r.filter(l=>y.includes(l.id)),i=r.filter(l=>!q.includes(l.id)&&!y.includes(l.id));return{weapons:M,armor:w,accessories:N,otherEquipment:i,miscellaneous:k}},[]),A=s.useMemo(()=>{if(!Te.trim())return Fe;const e=Te.toLowerCase().trim(),r=k=>k.name.toLowerCase().includes(e);return{weapons:Fe.weapons.filter(r),armor:Fe.armor.filter(r),accessories:Fe.accessories.filter(r),otherEquipment:Fe.otherEquipment.filter(r),miscellaneous:Fe.miscellaneous.filter(r)}},[Fe,Te]),Ve=s.useCallback(e=>{At(r=>r.includes(e)?r.filter(k=>k!==e):[...r,e])},[]),Et=s.useCallback(e=>{Bt(r=>r.includes(e)?r.filter(k=>k!==e):[...r,e]),Pt(""),setTimeout(()=>{qt.current&&qt.current.focus()},0)},[]),Ee=s.useCallback(e=>{he(e)},[]),Wt=s.useCallback(async(e=!1)=>{if(F.length===0&&te.length===0)return K("請至少選擇一個職業或分類","warning"),null;if(!O||!G)return K("請選擇伺服器","warning"),null;let r=new Set;const k=F.filter(i=>i>=8&&i<=18),u=F.filter(i=>i>=1&&i<=7||i>=19&&i<=42);if(k.length>0){const{recipes:i}=await Ht();k.forEach(n=>{i.forEach(o=>{o.job===n&&o.result&&r.add(o.result)})});const l=await ut(),c=k.map(n=>rt(n)).filter(n=>n);Object.entries(l).forEach(([n,o])=>{o.jobs&&Array.isArray(o.jobs)&&c.some($=>o.jobs.includes($))&&r.add(parseInt(n,10))})}if(u.length>0){const i=await ut(),l=u.map(c=>rt(c)).filter(c=>c);Object.entries(i).forEach(([c,n])=>{n.jobs&&Array.isArray(n.jobs)&&l.some(R=>n.jobs.includes(R))&&r.add(parseInt(c,10))})}if(te.length>0){const i=await Ut();let l=new Set;if(te.forEach(c=>{c==="main_weapon"?F.length>0?F.forEach(n=>{const o=Cr[n];o&&o.forEach(re=>l.add(re));const R=Sr[n];R&&l.add(R);const $=Pr[n];$&&l.add($)}):zt.主武器.forEach(n=>l.add(n)):c==="offhand_weapon"?F.length>0?F.forEach(n=>{const o=jr[n];o&&l.add(o);const R=Nr[n];R&&l.add(R);const $=kr[n];$&&l.add($)}):zt.副手武器.forEach(n=>l.add(n)):l.add(parseInt(c,10))}),r.size===0&&F.length===0&&Object.keys(mt).forEach(c=>{r.add(parseInt(c,10))}),l.size>0){const c=new Set;r.forEach(n=>{const o=i[n.toString()];kt.includes(o)||o&&l.has(o)&&c.add(n)}),r=c}else{const c=new Set;r.forEach(n=>{const o=i[n.toString()];kt.includes(o)||c.add(n)}),r=c}}if(be>1||ve<999){const i=await ut(),l=new Set;r.forEach(c=>{const n=i[c.toString()];!n||n.level===void 0||n.level===null?be===1&&ve===999&&l.add(c):n.level>=be&&n.level<=ve&&l.add(c)}),r=l}if(He.trim()){const i=new Set,l=He.trim().split(/\s+/).filter(n=>n),c=(n,o)=>{const R=Array.from(n.toLowerCase()),$=Array.from(o.toLowerCase());if(o.toLowerCase().includes(n.toLowerCase()))return!0;let re=0,me=0,ie=0,Ie=0;for(let f=0;f<R.length;f++){const b=R[f];let j=!1;for(let P=me;P<$.length;P++)if($[P]===b){re++,j=!0,P===me?(ie++,Ie=Math.max(Ie,ie)):ie=1,me=P+1;break}if(!j){for(let P=0;P<$.length;P++)if($[P]===b){re++,j=!0,ie=1,me=P+1;break}}j||(ie=0)}const I=re/R.length,a=Ie/R.length*.3;return I*.7+a>=.6};r.forEach(n=>{const o=mt?.[n.toString()];if(o&&o.tw){const R=o.tw;let $=!1;if(ke)$=l.every(re=>c(re,R));else{const re=R.toLowerCase(),me=He.trim().toLowerCase();$=re===me}$&&i.add(n)}}),r=i}if(r.size===0)return K("未找到符合條件的物品","warning"),null;const M=await Mt();St(M);const q=Array.from(r);let y=q.filter(i=>M.has(i));const w=q.filter(i=>!M.has(i));if(y.length===0&&w.length===0)return K("未找到符合條件的物品","warning"),null;y.length===0&&w.length>0&&pe(!0);const N=await it();return y=y.sort((i,l)=>{const c=N[i?.toString()]||null,n=N[l?.toString()]||null;return c!==null&&n!==null?n-c:c!==null?-1:n!==null?1:l-i}),!e&&y.length>st?(Ae({total:y.length,limit:st}),null):{itemIds:r,tradeableItemIds:y,untradeableItemIds:w}},[F,te,O,G,be,ve,He,ke,K,Ht,ut,Ut,it,rt]),Gt=s.useCallback(async()=>{if(Ae(null),Ye)return;const e=++g.current;H.current&&(H.current.abort(),H.current=null),J.current++,qe.current=!1,Re(!1),X(!1),ee([]),fe([]),pe(!1),Me({}),Le({}),$e({}),De({}),xe({}),Rt([]),he(1),et(!0),setTimeout(()=>{et(!1)},1500);try{if(z(!0),e!==g.current){z(!1);return}const r=await Wt();if(e!==g.current){z(!1);return}if(!r){z(!1);return}const{tradeableItemIds:k,untradeableItemIds:u}=r;if(e!==g.current){z(!1);return}Ae(null);const M=await Mt();if(e!==g.current){z(!1);return}St(M);const q=k.filter(N=>M.has(N)),y=await it();if(e!==g.current){z(!1);return}const w=async(N,i)=>{if(e!==g.current)return;const l=y,n=[...i?N.filter(I=>M.has(I)):N].sort((I,a)=>{const d=l[I?.toString()]||null,f=l[a?.toString()]||null;return d!==null&&f!==null?f-d:d!==null?-1:f!==null?1:a-I}),o=20,R=n.slice(0,o),$=i?R.filter(I=>M.has(I)):R,me=$.map(I=>{const d=mt[I?.toString()]?.tw||`物品 (ID: ${I})`;return{id:I,name:d,itemLevel:"",shopPrice:"",description:"",inShop:!1,canBeHQ:!0,isTradable:!0}}).sort((I,a)=>{const d=l[I.id?.toString()]||null,f=l[a.id?.toString()]||null;return d!==null&&f!==null?f-d:d!==null?-1:f!==null?1:a.id-I.id});if(i?(ee([]),Ke.flushSync(()=>{ee(me)}),(async()=>{const I=$.map(b=>Qe(b)),a=(await Promise.all(I)).filter(b=>b!==null);if(e!==g.current)return;const f=a.filter(b=>M.has(b.id)).sort((b,j)=>{const P=l[b.id?.toString()]||null,m=l[j.id?.toString()]||null;return P!==null&&m!==null?m-P:P!==null?-1:m!==null?1:j.id-b.id});e===g.current&&ee(f)})().catch(I=>{console.error("Error loading initial item details:",I)})):(fe(me),(async()=>{const I=R.map(f=>Qe(f)),a=(await Promise.all(I)).filter(f=>f!==null);if(e!==g.current)return;const d=a.sort((f,b)=>{const j=l[f.id?.toString()]||null,P=l[b.id?.toString()]||null;return j!==null&&P!==null?P-j:j!==null?-1:P!==null?1:b.id-f.id});e===g.current&&fe(d)})().catch(I=>{console.error("Error loading untradeable item details:",I)})),O&&G&&n.length>0&&i){if(e!==g.current)return;H.current&&H.current.abort();const I=++J.current;H.current=new AbortController;const a=H.current.signal;qe.current=!0,Re(!0),X(!0),(async()=>{const d=G===O.section,f=d?O.section:G,b=(m,h,C)=>{const p=m?.world?.[C],S=h?.world?.[C],E=m?.dc?.[C],D=h?.dc?.[C],B=d?E!==void 0?E:p:p!==void 0?p:void 0,T=d?D!==void 0?D:S:S!==void 0?S:void 0;if(C==="quantity"){if(B!==void 0||T!==void 0)return(B||0)+(T||0)}else{if(B!==void 0&&T!==void 0)return Math.min(B,T);if(T!==void 0)return T;if(B!==void 0)return B}return null},j=async(m,h)=>{if(a.aborted||I!==J.current||e!==g.current)return;let C;m===0?C=20:m===1?C=50:C=100;const p=n.slice(h,h+C);if(p.length===0)return;const S=p.join(",");try{const E=await fetch(`https://universalis.app/api/v2/aggregated/${encodeURIComponent(f)}/${S}`,{signal:a});if(a.aborted||I!==J.current||e!==g.current)return;const D=await E.json();if(D&&D.results){const B={},T={},se={},nt={},Ue={};D.results.forEach(v=>{const x=v.itemId,Ce=b(v.nq?.dailySaleVelocity,v.hq?.dailySaleVelocity,"quantity");let ce=null;if(d)ce=b(v.nq?.averageSalePrice,v.hq?.averageSalePrice,"price");else{const Q=v.nq?.averageSalePrice?.world?.price,V=v.hq?.averageSalePrice?.world?.price,_=v.nq?.averageSalePrice?.dc?.price,W=v.hq?.averageSalePrice?.dc?.price,ae=Q!==void 0?Q:_,Ne=V!==void 0?V:W;ae!==void 0&&Ne!==void 0?ce=Math.min(ae,Ne):Ne!==void 0?ce=Ne:ae!==void 0&&(ce=ae)}const oe=b(v.nq?.minListing,v.hq?.minListing,"price"),Se=b(v.nq?.recentPurchase,v.hq?.recentPurchase,"price");let de=null;if(oe!=null)if(d)de=oe;else{const Q=v.nq?.minListing?.world?.price,V=v.hq?.minListing?.world?.price;let _=null;if(Q!==void 0&&V!==void 0?_=V<=Q?v.hq?.minListing?.world:v.nq?.minListing?.world:V!==void 0?_=v.hq?.minListing?.world:Q!==void 0&&(_=v.nq?.minListing?.world),_!==null){const W=_?.region;de={price:oe},W!==void 0&&(de.region=W)}}let ne=null;if(Se!=null)if(d)ne=Se;else{const Q=v.nq?.recentPurchase?.world?.price,V=v.hq?.recentPurchase?.world?.price;let _=null;Q!==void 0&&V!==void 0?_=V<=Q?v.hq?.recentPurchase?.world:v.nq?.recentPurchase?.world:V!==void 0?_=v.hq?.recentPurchase?.world:Q!==void 0&&(_=v.nq?.recentPurchase?.world);const W=_?.region;ne={price:Se},W!==void 0&&(ne.region=W)}Ce!=null&&(B[x]=Ce),ce!=null&&(T[x]=Math.round(ce)),de!=null&&(se[x]=de),ne!=null&&(nt[x]=ne),Ue[x]=!0}),p.forEach(v=>{Ue.hasOwnProperty(v)||(Ue[v]=!1)}),!a.aborted&&I===J.current&&e===g.current&&(Ke.flushSync(()=>{Me(v=>({...v,...B})),Le(v=>({...v,...T})),$e(v=>({...v,...se})),De(v=>({...v,...nt})),xe(v=>({...v,...Ue}))}),m===0&&X(!1))}}catch(E){if(E.name==="AbortError"||a.aborted)return;console.error("Error fetching market data:",E);const D={};p.forEach(B=>{D[B]=!1}),!a.aborted&&I===J.current&&e===g.current&&Ke.flushSync(()=>{xe(B=>({...B,...D}))})}},P=async(m,h)=>{if(a.aborted||I!==J.current||e!==g.current)return;if(h>=n.length){I===J.current&&e===g.current&&!a.aborted&&(X(!1),qe.current=!1,Re(!1));return}if(await j(m,h),a.aborted||I!==J.current||e!==g.current)return;let C;m===0?C=20:m===1?C=50:C=100;const p=h+C;p<n.length?await new Promise(S=>{setTimeout(()=>{P(m+1,p).then(S)},m===0?0:100)}):I===J.current&&e===g.current&&!a.aborted&&(X(!1),qe.current=!1,Re(!1))};try{await P(0,0)}catch(m){m.name!=="AbortError"&&console.error("Error in market data fetch:",m)}})().catch(d=>{d.name!=="AbortError"&&console.error("Error in market data fetch:",d)})}const ie=50,Ie=async I=>{if(e!==g.current)return;const a=o+I*ie;if(a>=n.length)return;const d=n.slice(a,a+ie);if(d.length===0)return;const f=d.map(m=>Qe(m)),b=(await Promise.all(f)).filter(m=>m!==null);if(e!==g.current)return;const P=(i?b.filter(m=>M.has(m.id)):b).sort((m,h)=>{const C=y[m.id?.toString()]||null,p=y[h.id?.toString()]||null;return C!==null&&p!==null?p-C:C!==null?-1:p!==null?1:h.id-m.id});e===g.current&&(i?ee(m=>[...m,...P].sort((C,p)=>{const S=y[C.id?.toString()]||null,E=y[p.id?.toString()]||null;return S!==null&&E!==null?E-S:S!==null?-1:E!==null?1:p.id-C.id})):fe(m=>[...m,...P].sort((C,p)=>{const S=y[C.id?.toString()]||null,E=y[p.id?.toString()]||null;return S!==null&&E!==null?E-S:S!==null?-1:E!==null?1:p.id-C.id})),await new Promise(m=>{setTimeout(()=>{Ie(I+1).then(m)},50)}))};n.length>o&&Ie(0).catch(I=>{console.error("Error loading remaining batches:",I)})};if(q.length>0?(pe(!1),w(q,!0).catch(N=>{console.error("Error loading tradeable items progressively:",N)}),u.length>0&&w(u,!1).catch(N=>{console.error("Error loading untradeable items:",N)})):u.length>0&&w(u,!1).catch(N=>{console.error("Error loading untradeable items:",N)}),e!==g.current){z(!1);return}(q.length>0||u.length>0)&&K(`找到 ${q.length} 個可交易物品${u.length>0?`、${u.length} 個不可交易物品`:""}`,"success"),z(!1)}catch(r){if(e!==g.current)return;console.error("Filter search error:",r),K("搜索失敗，請稍後再試","error"),X(!1),z(!1)}},[F,te,O,G,K,U,Z,He,be,ve,ke,Ye]);return t.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-slate-950 via-slate-900 via-purple-950/30 to-slate-950 text-white",children:[t.jsx(Lr,{onSearch:er,isSearching:Z,searchText:tr,setSearchText:lt,isServerDataLoaded:ze,selectedDcName:O?.section,onItemSelect:xt,showNavigationButtons:!0,activePage:"advanced-search",onTaxRatesClick:rr,onAdvancedSearchClick:()=>{lt(""),bt("/advanced-search")},onMSQPriceCheckerClick:()=>{lt(""),bt("/msq-price-checker")},onUltimatePriceKingClick:()=>{lt(""),bt("/ultimate-price-king")}}),t.jsx("div",{className:"fixed right-2 mid:right-4 left-2 mid:left-auto z-50 space-y-2 max-w-sm mid:max-w-none top-[60px] mid:top-4",children:Qt.map(e=>t.jsx($r,{message:e.message,type:e.type,onClose:()=>Ot(e.id)},e.id))}),t.jsx("div",{className:"pt-24 pb-8",children:t.jsxs("div",{className:"max-w-7xl mx-auto px-4",children:[t.jsxs("div",{className:"mb-6",children:[t.jsx("h1",{className:"text-3xl sm:text-4xl font-bold text-ffxiv-gold mb-2",children:"進階搜尋"}),t.jsx("p",{className:"text-gray-400 text-sm sm:text-base",children:"批量搜尋多個物品的市場價格，或使用篩選條件進行搜尋。"})]}),t.jsxs("div",{className:"mb-6 flex gap-2 border-b border-purple-500/30",children:[t.jsx("button",{onClick:()=>{vt("filter"),ar(""),Ae(null),We(1),Ge(999),jt(""),pe(!1),ee([]),fe([]),Me({}),Le({}),$e({}),De({}),xe({}),he(1),H.current&&H.current.abort(),X(!1)},className:`px-4 py-2 font-semibold transition-all border-b-2 ${Y==="filter"?"text-ffxiv-gold border-ffxiv-gold":"text-gray-400 border-transparent hover:text-gray-300"}`,children:"篩選搜尋"}),t.jsx("div",{className:"relative",title:"敬请期待",children:t.jsx("button",{onClick:()=>{},disabled:yt,className:"px-4 py-2 font-semibold transition-all border-b-2 text-gray-500 border-transparent cursor-not-allowed opacity-50",children:"批量搜尋（開發中）"})})]}),Y==="batch"&&!yt,Y==="filter"&&t.jsxs("div",{className:"bg-gradient-to-br from-slate-800/60 via-purple-900/20 to-slate-800/60 backdrop-blur-sm rounded-lg border border-purple-500/20 p-4 sm:p-6 mb-6",children:[t.jsx("div",{className:"bg-slate-700/80 border border-slate-500/50 rounded-lg p-4 mb-6",children:t.jsx("p",{className:"text-sm text-gray-200 leading-relaxed",children:"這個頁面測試量過於龐大，作者個人時間有限。各位使用大大有發現bug歡迎參考主頁上的巴哈或dc方式回報，感激感激"})}),t.jsxs("div",{className:"mb-6 grid grid-cols-1 lg:grid-cols-2 gap-6 items-stretch",children:[t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-semibold text-ffxiv-gold mb-4",children:"選擇職業"}),t.jsxs("div",{className:"space-y-[0.86821875rem]",children:[t.jsxs("div",{className:"flex flex-wrap gap-2",children:[ge.tank.map(e=>{const r=F.includes(e.id);return t.jsx("button",{onClick:()=>Ve(e.id),title:e.name,className:`p-2 rounded-lg border transition-all ${r?"bg-gradient-to-r from-ffxiv-gold/20 to-yellow-500/20 border-ffxiv-gold":e.roleColor?"hover:opacity-90":"bg-slate-900/50 border-purple-500/30 hover:border-purple-500/50"}`,style:!r&&e.roleColor?{backgroundColor:`${e.roleColor}75`,borderColor:`${e.roleColor}90`,borderWidth:"1px"}:{},children:Be.has(e.id)?t.jsx("span",{className:"w-8 h-8 flex items-center justify-center text-[10px] font-semibold text-gray-300 leading-tight text-center px-1",children:e.name}):t.jsx("img",{src:e.iconUrl,alt:e.name,className:"w-8 h-8 object-contain",onError:()=>_e(e.id)})},e.id)}),ge.tank.length>0&&ge.healer.length>0&&t.jsx("div",{className:"w-px h-8 bg-purple-500/20 mx-1"}),ge.healer.map(e=>{const r=F.includes(e.id);return t.jsx("button",{onClick:()=>Ve(e.id),title:e.name,className:`p-2 rounded-lg border transition-all ${r?"bg-gradient-to-r from-ffxiv-gold/20 to-yellow-500/20 border-ffxiv-gold":e.roleColor?"hover:opacity-90":"bg-slate-900/50 border-purple-500/30 hover:border-purple-500/50"}`,style:!r&&e.roleColor?{backgroundColor:`${e.roleColor}75`,borderColor:`${e.roleColor}90`,borderWidth:"1px"}:{},children:Be.has(e.id)?t.jsx("span",{className:"w-8 h-8 flex items-center justify-center text-[10px] font-semibold text-gray-300 leading-tight text-center px-1",children:e.name}):t.jsx("img",{src:e.iconUrl,alt:e.name,className:"w-8 h-8 object-contain",onError:()=>_e(e.id)})},e.id)})]}),t.jsxs("div",{className:"flex flex-wrap gap-2 pt-[0.5788125rem] border-t border-purple-500/10",children:[ge.melee.map(e=>{const r=F.includes(e.id);return t.jsx("button",{onClick:()=>Ve(e.id),title:e.name,className:`p-2 rounded-lg border transition-all ${r?"bg-gradient-to-r from-ffxiv-gold/20 to-yellow-500/20 border-ffxiv-gold":e.roleColor?"hover:opacity-90":"bg-slate-900/50 border-purple-500/30 hover:border-purple-500/50"}`,style:!r&&e.roleColor?{backgroundColor:`${e.roleColor}75`,borderColor:`${e.roleColor}90`,borderWidth:"1px"}:{},children:Be.has(e.id)?t.jsx("span",{className:"w-8 h-8 flex items-center justify-center text-[10px] font-semibold text-gray-300 leading-tight text-center px-1",children:e.name}):t.jsx("img",{src:e.iconUrl,alt:e.name,className:"w-8 h-8 object-contain",onError:()=>_e(e.id)})},e.id)}),ge.melee.length>0&&ge.ranged.length>0&&t.jsx("div",{className:"w-px h-8 bg-purple-500/20 mx-1"}),ge.ranged.map(e=>{const r=F.includes(e.id);return t.jsx("button",{onClick:()=>Ve(e.id),title:e.name,className:`p-2 rounded-lg border transition-all ${r?"bg-gradient-to-r from-ffxiv-gold/20 to-yellow-500/20 border-ffxiv-gold":e.roleColor?"hover:opacity-90":"bg-slate-900/50 border-purple-500/30 hover:border-purple-500/50"}`,style:!r&&e.roleColor?{backgroundColor:`${e.roleColor}75`,borderColor:`${e.roleColor}90`,borderWidth:"1px"}:{},children:Be.has(e.id)?t.jsx("span",{className:"w-8 h-8 flex items-center justify-center text-[10px] font-semibold text-gray-300 leading-tight text-center px-1",children:e.name}):t.jsx("img",{src:e.iconUrl,alt:e.name,className:"w-8 h-8 object-contain",onError:()=>_e(e.id)})},e.id)})]}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 pt-[0.5788125rem] border-t border-purple-500/10",children:[ge.caster.length>0&&t.jsx("div",{className:"flex flex-wrap gap-2",children:ge.caster.map(e=>{const r=F.includes(e.id);return t.jsx("button",{onClick:()=>Ve(e.id),title:e.name,className:`p-2 rounded-lg border transition-all ${r?"bg-gradient-to-r from-ffxiv-gold/20 to-yellow-500/20 border-ffxiv-gold":e.roleColor?"hover:opacity-90":"bg-slate-900/50 border-purple-500/30 hover:border-purple-500/50"}`,style:!r&&e.roleColor?{backgroundColor:`${e.roleColor}75`,borderColor:`${e.roleColor}90`,borderWidth:"1px"}:{},children:Be.has(e.id)?t.jsx("span",{className:"w-8 h-8 flex items-center justify-center text-[10px] font-semibold text-gray-300 leading-tight text-center px-1",children:e.name}):t.jsx("img",{src:e.iconUrl,alt:e.name,className:"w-8 h-8 object-contain",onError:()=>_e(e.id)})},e.id)})}),t.jsx("div",{className:"flex flex-wrap gap-2",children:yr.map(e=>{const r=F.includes(e.id);return t.jsx("button",{onClick:()=>Ve(e.id),title:e.name,className:`p-2 rounded-lg border transition-all ${r?"bg-gradient-to-r from-ffxiv-gold/20 to-yellow-500/20 border-ffxiv-gold":e.roleColor?"hover:opacity-90":"bg-slate-900/50 border-purple-500/30 hover:border-purple-500/50"}`,style:!r&&e.roleColor?{backgroundColor:`${e.roleColor}60`,borderColor:`${e.roleColor}80`,borderWidth:"1px"}:{},children:Be.has(e.id)?t.jsx("span",{className:"w-8 h-8 flex items-center justify-center text-[10px] font-semibold text-gray-300 leading-tight text-center px-1",children:e.name}):t.jsx("img",{src:e.iconUrl,alt:e.name,className:"w-8 h-8 object-contain",onError:()=>_e(e.id)})},e.id)})})]}),t.jsx("div",{className:"flex flex-wrap gap-2 pt-[0.5788125rem] border-t border-purple-500/20",children:vr.map(e=>{const r=F.includes(e.id);return t.jsx("button",{onClick:()=>Ve(e.id),title:e.name,className:`p-2 rounded-lg border transition-all ${r?"bg-gradient-to-r from-ffxiv-gold/20 to-yellow-500/20 border-ffxiv-gold":e.roleColor?"hover:opacity-90":"bg-slate-900/50 border-purple-500/30 hover:border-purple-500/50"}`,style:!r&&e.roleColor?{backgroundColor:`${e.roleColor}75`,borderColor:`${e.roleColor}90`,borderWidth:"1px"}:{},children:Be.has(e.id)?t.jsx("span",{className:"w-8 h-8 flex items-center justify-center text-[10px] font-semibold text-gray-300 leading-tight text-center px-1",children:e.name}):t.jsx("img",{src:e.iconUrl,alt:e.name,className:"w-8 h-8 object-contain",onError:()=>_e(e.id)})},e.id)})})]}),F.length>0&&t.jsxs("div",{className:"mt-2 text-xs text-gray-400",children:["已選擇 ",F.length," 個職業"]})]}),t.jsxs("div",{className:"flex flex-col",children:[t.jsx("label",{className:"block text-sm font-semibold text-ffxiv-gold mb-4",children:"選擇物品分類"}),t.jsxs("div",{className:"border border-purple-500/30 rounded-lg p-3 bg-slate-900/30 h-[290px] flex flex-col",children:[t.jsx("div",{className:"mb-3 flex-shrink-0",children:t.jsxs("div",{className:"relative",children:[t.jsx("div",{className:"absolute left-2.5 top-1/2 transform -translate-y-1/2 text-gray-400 z-10",children:t.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})})}),t.jsx("input",{ref:qt,type:"text",value:Te,onChange:e=>Pt(e.target.value),placeholder:"篩選搜尋分類",className:"w-full pl-9 pr-3 py-2 bg-slate-800/60 backdrop-blur-sm border border-purple-500/20 rounded-md text-white placeholder-gray-400 focus:outline-none focus:ring-1 focus:border-ffxiv-gold focus:ring-ffxiv-gold/50 transition-all text-xs"}),Te&&t.jsx("button",{onClick:()=>Pt(""),className:"absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-white transition-colors",title:"清除",children:t.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]})}),t.jsx("div",{className:"flex-1 overflow-y-auto",children:t.jsxs("div",{className:"space-y-3",children:[[...A.weapons,...A.armor,...A.otherEquipment,...A.accessories].length>0&&t.jsxs("div",{children:[t.jsx("div",{className:"text-xs font-semibold text-ffxiv-gold mb-2 px-1",children:"裝備類"}),[...A.weapons,...A.armor,...A.otherEquipment].length>0&&t.jsx("div",{className:"grid grid-cols-4 gap-2 mb-2",children:[...A.weapons,...A.armor,...A.otherEquipment].map(e=>{const r=typeof e.id=="string"?e.id:e.id.toString(),k=te.some(u=>(typeof u=="string"?u:u.toString())===r);return t.jsx("button",{onClick:()=>Et(e.id),className:`px-2 py-1.5 rounded text-xs transition-all text-center ${k?"bg-gradient-to-r from-ffxiv-gold/20 to-yellow-500/20 border border-ffxiv-gold text-ffxiv-gold":"bg-slate-800/50 border border-purple-500/20 text-gray-300 hover:border-purple-500/40"}`,children:e.name},e.id)})}),A.accessories.length>0&&t.jsx("div",{className:"grid grid-cols-4 gap-2",children:A.accessories.map(e=>{const r=typeof e.id=="string"?e.id:e.id.toString(),k=te.some(u=>(typeof u=="string"?u:u.toString())===r);return t.jsx("button",{onClick:()=>Et(e.id),className:`px-2 py-1.5 rounded text-xs transition-all text-center ${k?"bg-gradient-to-r from-ffxiv-gold/20 to-yellow-500/20 border border-ffxiv-gold text-ffxiv-gold":"bg-slate-800/50 border border-purple-500/20 text-gray-300 hover:border-purple-500/40"}`,children:e.name},e.id)})})]}),[...A.weapons,...A.armor,...A.otherEquipment,...A.accessories].length>0&&A.miscellaneous.length>0&&t.jsx("div",{className:"border-t border-purple-500/30 my-2"}),A.miscellaneous.length>0&&t.jsxs("div",{children:[t.jsx("div",{className:"text-xs font-semibold text-gray-400 mb-2 px-1",children:"雜物類"}),t.jsx("div",{className:"grid grid-cols-4 gap-2",children:A.miscellaneous.map(e=>{const r=typeof e.id=="string"?e.id:e.id.toString(),k=te.some(u=>(typeof u=="string"?u:u.toString())===r);return t.jsx("button",{onClick:()=>Et(e.id),className:`px-2 py-1.5 rounded text-xs transition-all text-center ${k?"bg-gradient-to-r from-ffxiv-gold/20 to-yellow-500/20 border border-ffxiv-gold text-ffxiv-gold":"bg-slate-800/50 border border-purple-500/20 text-gray-300 hover:border-purple-500/40"}`,children:e.name},e.id)})})]}),Te.trim()&&A.weapons.length===0&&A.armor.length===0&&A.accessories.length===0&&A.otherEquipment.length===0&&A.miscellaneous.length===0&&t.jsx("div",{className:"py-8 text-center",children:t.jsxs("div",{className:"text-sm text-gray-400",children:["沒有找到匹配「",Te,"」的分類"]})})]})})]}),te.length>0&&t.jsxs("div",{className:"mt-2 text-xs text-gray-400",children:["已選擇 ",te.length," 個分類"]}),t.jsx("div",{className:"mt-2 text-xs text-yellow-400"})]})]}),O&&t.jsxs("div",{className:"mb-6 flex flex-col lg:flex-row lg:justify-between gap-8 lg:gap-10",children:[t.jsxs("div",{className:"flex-shrink-0",children:[t.jsx("label",{className:"block text-sm font-semibold text-ffxiv-gold mb-2",children:"裝備等級範圍"}),t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("input",{type:"number",min:"1",max:"999",value:gr&&be===1?"":be,onChange:e=>{const r=e.target.value;if(r===""){We(1);return}const k=parseInt(r);if(!isNaN(k)){const u=Math.max(1,Math.min(999,k));We(u),u>ve&&Ge(u)}},onFocus:()=>{Tt(!0)},onBlur:e=>{Tt(!1),(e.target.value===""||e.target.value==="1")&&We(1)},disabled:Pe||U,placeholder:"1",className:"w-40 px-3 py-2 bg-slate-900/50 border border-purple-500/30 rounded-lg text-white focus:outline-none focus:border-ffxiv-gold disabled:opacity-50 disabled:cursor-not-allowed placeholder:text-gray-500 [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none [-moz-appearance:textfield]"}),t.jsx("div",{className:"text-gray-400",children:"~"}),t.jsx("input",{type:"number",min:"1",max:"999",value:mr&&ve===999?"":ve,onChange:e=>{const r=e.target.value;if(r===""){Ge(999);return}const k=parseInt(r);if(!isNaN(k)){const u=Math.max(1,Math.min(999,k));Ge(u),u<be&&We(u)}},onFocus:()=>{_t(!0)},onBlur:e=>{_t(!1),(e.target.value===""||e.target.value==="999")&&Ge(999)},disabled:Pe||U,placeholder:"999",className:"w-40 px-3 py-2 bg-slate-900/50 border border-purple-500/30 rounded-lg text-white focus:outline-none focus:border-ffxiv-gold disabled:opacity-50 disabled:cursor-not-allowed placeholder:text-gray-500 [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none [-moz-appearance:textfield]"})]})]}),t.jsxs("div",{className:"w-full lg:w-auto lg:ml-auto",children:[t.jsx("label",{className:"block text-sm font-semibold text-ffxiv-gold mb-2",children:"伺服器選擇"}),t.jsx(Dr,{datacenters:Kt,worlds:pt,selectedWorld:O,onWorldChange:Zt,selectedServerOption:G,onServerOptionChange:Xt,serverOptions:Yt,disabled:Pe||U})]})]}),Je&&t.jsx("div",{className:"mb-4 p-4 bg-yellow-900/40 border-2 border-yellow-500/50 rounded-lg",children:t.jsxs("div",{className:"flex items-start gap-3",children:[t.jsx("div",{className:"text-2xl",children:"⚠️"}),t.jsxs("div",{className:"flex-1",children:[t.jsx("h3",{className:"text-yellow-400 font-semibold mb-2",children:"找到的物品過多"}),t.jsxs("p",{className:"text-sm text-gray-300 mb-3",children:["找到 ",t.jsx("span",{className:"text-yellow-400 font-bold",children:Je.total})," 個可交易物品， 超過建議上限 ",t.jsx("span",{className:"text-yellow-400 font-bold",children:Je.limit})," 個。 處理過多物品可能會導致搜索時間過長或性能問題。"]}),t.jsxs("div",{className:"flex gap-2 flex-wrap",children:[t.jsx("button",{onClick:async()=>{const e=++g.current;H.current&&(H.current.abort(),H.current=null),J.current++,qe.current=!1,Re(!1),X(!1),Ae(null),z(!0),et(!1),ee([]),fe([]),pe(!1),Me({}),Le({}),$e({}),De({}),xe({}),Rt([]),et(!0),setTimeout(()=>{et(!1)},1500);try{const r=await Wt(!0);if(e!==g.current){z(!1);return}if(!r){z(!1);return}let{tradeableItemIds:k,untradeableItemIds:u}=r;if(e!==g.current){z(!1);return}const M=await Mt();if(e!==g.current){z(!1);return}St(M);const y=k.filter(i=>M.has(i)).slice(0,st);K(`已限制為前 ${y.length} 個物品，正在獲取市場數據...`,"warning");const w=await it();if(e!==g.current){z(!1);return}const N=async(i,l)=>{if(e!==g.current)return;const c=w,o=[...l?i.filter(a=>M.has(a)):i].sort((a,d)=>{const f=c[a?.toString()]||null,b=c[d?.toString()]||null;return f!==null&&b!==null?b-f:f!==null?-1:b!==null?1:d-a}),R=20,$=o.slice(0,R),re=l?$.filter(a=>M.has(a)):$,ie=re.map(a=>{const f=mt[a?.toString()]?.tw||`物品 (ID: ${a})`;return{id:a,name:f,itemLevel:"",shopPrice:"",description:"",inShop:!1,canBeHQ:!0,isTradable:!0}}).sort((a,d)=>{const f=c[a.id?.toString()]||null,b=c[d.id?.toString()]||null;return f!==null&&b!==null?b-f:f!==null?-1:b!==null?1:d.id-a.id});if(l?(ee([]),pe(!1),Ke.flushSync(()=>{ee(ie)}),(async()=>{const a=re.map(j=>Qe(j)),d=(await Promise.all(a)).filter(j=>j!==null);if(e!==g.current)return;const b=d.filter(j=>M.has(j.id)).sort((j,P)=>{const m=c[j.id?.toString()]||null,h=c[P.id?.toString()]||null;return m!==null&&h!==null?h-m:m!==null?-1:h!==null?1:P.id-j.id});e===g.current&&ee(b)})().catch(a=>{console.error("Error loading initial item details:",a)})):(fe(ie),(async()=>{const a=$.map(b=>Qe(b)),d=(await Promise.all(a)).filter(b=>b!==null);if(e!==g.current)return;const f=d.sort((b,j)=>{const P=c[b.id?.toString()]||null,m=c[j.id?.toString()]||null;return P!==null&&m!==null?m-P:P!==null?-1:m!==null?1:j.id-b.id});e===g.current&&fe(f)})().catch(a=>{console.error("Error loading untradeable item details:",a)})),O&&G&&o.length>0&&l){H.current&&H.current.abort();const a=++J.current;H.current=new AbortController;const d=H.current.signal;qe.current=!0,Re(!0),X(!0),(async()=>{const f=G===O.section,b=f?O.section:G,j=(h,C,p)=>{const S=h?.world?.[p],E=C?.world?.[p],D=h?.dc?.[p],B=C?.dc?.[p],T=f?D!==void 0?D:S:S!==void 0?S:void 0,se=f?B!==void 0?B:E:E!==void 0?E:void 0;if(p==="quantity"){if(T!==void 0||se!==void 0)return(T||0)+(se||0)}else{if(T!==void 0&&se!==void 0)return Math.min(T,se);if(se!==void 0)return se;if(T!==void 0)return T}return null},P=async(h,C)=>{if(d.aborted||a!==J.current||e!==g.current)return;let p;h===0?p=20:h===1?p=50:p=100;const S=o.slice(C,C+p);if(S.length===0)return;const E=S.join(",");try{const D=await fetch(`https://universalis.app/api/v2/aggregated/${encodeURIComponent(b)}/${E}`,{signal:d});if(d.aborted||a!==J.current||e!==g.current)return;const B=await D.json();if(B&&B.results){const T={},se={},nt={},Ue={},v={};B.results.forEach(x=>{const Ce=x.itemId,ce=j(x.nq?.dailySaleVelocity,x.hq?.dailySaleVelocity,"quantity");let oe=null;if(f)oe=j(x.nq?.averageSalePrice,x.hq?.averageSalePrice,"price");else{const V=x.nq?.averageSalePrice?.world?.price,_=x.hq?.averageSalePrice?.world?.price,W=x.nq?.averageSalePrice?.dc?.price,ae=x.hq?.averageSalePrice?.dc?.price,Ne=V!==void 0?V:W,ht=_!==void 0?_:ae;Ne!==void 0&&ht!==void 0?oe=Math.min(Ne,ht):ht!==void 0?oe=ht:Ne!==void 0&&(oe=Ne)}const Se=j(x.nq?.minListing,x.hq?.minListing,"price"),de=j(x.nq?.recentPurchase,x.hq?.recentPurchase,"price");let ne=null;if(Se!=null)if(f)ne=Se;else{const V=x.nq?.minListing?.world?.price,_=x.hq?.minListing?.world?.price;let W=null;if(V!==void 0&&_!==void 0?W=_<=V?x.hq?.minListing?.world:x.nq?.minListing?.world:_!==void 0?W=x.hq?.minListing?.world:V!==void 0&&(W=x.nq?.minListing?.world),W!==null){const ae=W?.region;ne={price:Se},ae!==void 0&&(ne.region=ae)}}let Q=null;if(de!=null)if(f)Q=de;else{const V=x.nq?.recentPurchase?.world?.price,_=x.hq?.recentPurchase?.world?.price;let W=null;V!==void 0&&_!==void 0?W=_<=V?x.hq?.recentPurchase?.world:x.nq?.recentPurchase?.world:_!==void 0?W=x.hq?.recentPurchase?.world:V!==void 0&&(W=x.nq?.recentPurchase?.world);const ae=W?.region;Q={price:de},ae!==void 0&&(Q.region=ae)}ce!=null&&(T[Ce]=ce),oe!=null&&(se[Ce]=Math.round(oe)),ne!=null&&(nt[Ce]=ne),Q!=null&&(Ue[Ce]=Q),v[Ce]=!0}),S.forEach(x=>{v.hasOwnProperty(x)||(v[x]=!1)}),!d.aborted&&a===J.current&&e===g.current&&(Ke.flushSync(()=>{Me(x=>({...x,...T})),Le(x=>({...x,...se})),$e(x=>({...x,...nt})),De(x=>({...x,...Ue})),xe(x=>({...x,...v}))}),h===0&&X(!1))}}catch(D){if(D.name==="AbortError"||d.aborted)return;console.error("Error fetching market data:",D);const B={};S.forEach(T=>{B[T]=!1}),!d.aborted&&a===J.current&&e===g.current&&Ke.flushSync(()=>{xe(T=>({...T,...B}))})}},m=async(h,C)=>{if(d.aborted||a!==J.current||e!==g.current)return;if(C>=o.length){a===J.current&&e===g.current&&!d.aborted&&(X(!1),qe.current=!1,Re(!1));return}if(await P(h,C),d.aborted||a!==J.current||e!==g.current)return;let p;h===0?p=20:h===1?p=50:p=100;const S=C+p;S<o.length?await new Promise(E=>{setTimeout(()=>{m(h+1,S).then(E)},h===0?0:100)}):a===J.current&&e===g.current&&!d.aborted&&(X(!1),qe.current=!1,Re(!1))};try{await m(0,0)}catch(h){h.name!=="AbortError"&&console.error("Error in market data fetch:",h)}})().catch(f=>{f.name!=="AbortError"&&console.error("Error in market data fetch:",f)})}const Ie=50,I=async a=>{if(e!==g.current)return;const d=R+a*Ie;if(d>=o.length)return;const f=o.slice(d,d+Ie);if(f.length===0)return;const b=f.map(h=>Qe(h)),j=(await Promise.all(b)).filter(h=>h!==null);if(e!==g.current)return;const m=(l?j.filter(h=>M.has(h.id)):j).sort((h,C)=>{const p=w[h.id?.toString()]||null,S=w[C.id?.toString()]||null;return p!==null&&S!==null?S-p:p!==null?-1:S!==null?1:C.id-h.id});e===g.current&&(l?ee(h=>[...h,...m].sort((p,S)=>{const E=w[p.id?.toString()]||null,D=w[S.id?.toString()]||null;return E!==null&&D!==null?D-E:E!==null?-1:D!==null?1:S.id-p.id})):fe(h=>[...h,...m].sort((p,S)=>{const E=w[p.id?.toString()]||null,D=w[S.id?.toString()]||null;return E!==null&&D!==null?D-E:E!==null?-1:D!==null?1:S.id-p.id})),await new Promise(h=>{setTimeout(()=>{I(a+1).then(h)},50)}))};o.length>R&&I(0).catch(a=>{console.error("Error loading remaining batches:",a)})};if(y.length>0?(pe(!1),N(y,!0).catch(i=>{console.error("Error loading tradeable items progressively:",i)}),u.length>0&&N(u,!1).catch(i=>{console.error("Error loading untradeable items:",i)})):u.length>0&&N(u,!1).catch(i=>{console.error("Error loading untradeable items:",i)}),e!==g.current){z(!1);return}(y.length>0||u.length>0)&&K(`找到 ${y.length} 個可交易物品${u.length>0?`、${u.length} 個不可交易物品`:""}`,"success"),z(!1)}catch(r){if(e!==g.current)return;console.error("Continue search error:",r),K("搜索失敗，請稍後再試","error"),X(!1),z(!1)}},className:"confirm-button-attention py-3",children:t.jsxs("span",{className:"flex items-center gap-2",children:[t.jsx("span",{children:"確認"}),t.jsxs("span",{children:["繼續搜索（限制為前 ",st," 個）"]})]})}),t.jsx("button",{onClick:()=>Ae(null),className:"px-4 py-2 bg-slate-700/50 border border-gray-500/50 rounded-lg text-gray-300 hover:bg-slate-700/70 transition-all text-sm font-medium",children:"取消"})]})]})]})}),t.jsxs("div",{className:"flex gap-3",children:[t.jsxs("div",{className:"w-[40%] relative",children:[t.jsx("div",{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 z-10",children:t.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})})}),t.jsx("input",{type:"text",value:He,onChange:e=>jt(e.target.value),onKeyDown:e=>{e.key==="Enter"&&!U&&!Z&&(F.length>0||te.length>0)&&!Je&&Gt()},placeholder:"物品名篩選（多關鍵詞用空格分隔）",disabled:U||Z,className:`w-full py-3 pl-10 pr-20 rounded-lg bg-slate-900/90 backdrop-blur-sm border text-white placeholder-gray-400 focus:outline-none focus:ring-1 transition-all text-sm shadow-lg ${U||Z?"border-slate-700/30 cursor-not-allowed opacity-60":"border-purple-500/40 focus:border-ffxiv-gold focus:ring-ffxiv-gold/50 shadow-purple-500/20"}`}),t.jsxs("div",{className:"absolute right-2 top-1/2 transform -translate-y-1/2 z-10 flex items-center gap-1.5",children:[t.jsxs("label",{className:"flex items-center cursor-pointer group",title:ke?"開啟精準搜尋":"關閉精準搜尋",children:[t.jsx("input",{type:"checkbox",checked:!ke,onChange:e=>pr(!e.target.checked),disabled:U||Z,className:"sr-only"}),t.jsx("div",{className:`relative w-9 h-5 rounded-full transition-colors duration-200 ${U||Z?"opacity-50 cursor-not-allowed":"cursor-pointer"} ${ke?"bg-slate-600/60":"bg-ffxiv-gold/80"}`,children:t.jsx("div",{className:`absolute top-0.5 left-0.5 w-4 h-4 bg-white rounded-full transition-transform duration-200 ${ke?"translate-x-0":"translate-x-4"}`})})]}),t.jsx("span",{className:`text-xs whitespace-nowrap select-none ${U||Z?"text-gray-500":ke?"text-gray-400":"text-ffxiv-gold"}`,children:"精準"})]})]}),t.jsx("button",{onClick:Gt,disabled:U||Z||Ye||F.length===0&&te.length===0||Je!==null,className:`flex-1 py-3 rounded-lg font-semibold transition-all ${U||Z||Ye||F.length===0&&te.length===0||Je!==null?"bg-slate-700/50 text-gray-500 cursor-not-allowed opacity-50":"bg-gradient-to-r from-ffxiv-gold to-yellow-500 text-slate-900 hover:shadow-[0_0_20px_rgba(212,175,55,0.5)]"}`,children:U||Z?"搜索中...":"搜索"}),t.jsx("button",{onClick:()=>{At([]),Bt([]),We(1),Ge(999),jt(""),ee([]),fe([]),pe(!1),Me({}),Le({}),$e({}),De({}),xe({}),he(1),Ae(null),H.current&&H.current.abort(),X(!1),z(!1)},disabled:U||Z,className:`flex-1 py-3 rounded-lg font-semibold transition-all ${U||Z?"bg-slate-700/50 text-gray-500 cursor-not-allowed opacity-50":"bg-red-600/60 text-white border border-red-500/50 hover:bg-red-600/80 hover:border-red-400/70 hover:shadow-[0_0_20px_rgba(220,38,38,0.5)]"}`,children:"清空篩選"})]})]}),(()=>{const e=le.length>0;if(!(Y==="filter"?e||!e&&ue.length>0:Y==="batch"&&!yt))return null;const u=Y==="filter"?je?ue:le:[],M=(()=>{if(!we)return{};const n={};return u.forEach(o=>{const R=we[o.id?.toString()]!==void 0?we[o.id.toString()]:0;n[R]=(n[R]||0)+1}),n})();let q=u,y=q;Dt&&q.some(o=>Ct?.[o.id]===!0)&&(y=q.filter(o=>Ct?.[o.id]===!0)),tt.length>0&&we&&(q=q.filter(n=>{const o=we[n.id?.toString()]!==void 0?we[n.id.toString()]:0;return tt.includes(o)}),y=y.filter(n=>{const o=we[n.id?.toString()]!==void 0?we[n.id.toString()]:0;return tt.includes(o)}));const w=Math.ceil(q.length/ye),i=((w>0?Math.min(L,w):1)-1)*ye,l=i+ye,c=q.slice(i,l);return t.jsxs("div",{className:"mb-6",children:[t.jsxs("div",{className:"flex items-center gap-3 mb-4 flex-wrap",children:[t.jsxs("h2",{className:"text-xl sm:text-2xl font-bold text-ffxiv-gold",children:["搜索結果 (",q.length," 個物品",y.length!==q.length?`，顯示 ${y.length} 個`:"",")"]}),O&&G&&t.jsxs("div",{className:"flex items-center gap-2 px-3 py-1.5 bg-gradient-to-r from-purple-900/40 via-pink-900/30 to-indigo-900/40 border border-purple-500/30 rounded-lg backdrop-blur-sm",children:[t.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-ffxiv-gold animate-pulse"}),t.jsx("span",{className:"text-xs sm:text-sm font-semibold text-ffxiv-gold",children:G===O.section?`${O.section} (全服)`:pt[G]||`伺服器 ${G}`})]}),Y==="filter"&&ue.length>0&&le.length>0&&ze&&!Pe&&!ot&&!Nt&&!U&&t.jsx("button",{onClick:()=>{pe(!je),he(1)},className:`px-3 py-1.5 rounded-lg text-xs sm:text-sm font-semibold transition-all duration-200 backdrop-blur-sm shadow-sm ${je?"bg-gradient-to-r from-slate-700/70 via-slate-600/60 to-slate-700/70 text-gray-200 border border-slate-500/50 hover:from-slate-600/80 hover:via-slate-500/70 hover:to-slate-600/80 hover:border-slate-400/60 hover:shadow-md":"bg-gradient-to-r from-slate-800/70 via-slate-700/60 to-slate-800/70 text-gray-300 border border-slate-600/50 hover:from-slate-700/80 hover:via-slate-600/70 hover:to-slate-700/80 hover:border-slate-500/60 hover:shadow-md hover:text-gray-200"}`,children:je?"隱藏不可交易物品":`顯示不可以交易物品${ue.length}個`}),xr&&t.jsxs("div",{className:"flex items-center gap-2 px-2 py-1 bg-slate-800/50 border border-purple-500/30 rounded-lg",children:[t.jsx("div",{className:"animate-spin rounded-full h-3 w-3 border-b-2 border-ffxiv-gold"}),t.jsx("span",{className:"text-xs text-gray-300",children:"載入中..."})]})]}),q.length>ye&&t.jsxs("div",{className:"mb-4 flex items-center justify-between flex-wrap gap-3 bg-gradient-to-br from-slate-800/60 via-purple-900/20 to-slate-800/60 backdrop-blur-sm rounded-lg border border-purple-500/20 p-3",children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("label",{className:"text-sm text-gray-300",children:"每頁顯示:"}),t.jsxs("select",{value:ye,onChange:n=>{const o=parseInt(n.target.value,10);Ft(o),he(1)},className:"px-3 py-1.5 bg-slate-900/50 border border-purple-500/30 rounded-lg text-white text-sm focus:outline-none focus:border-ffxiv-gold",children:[t.jsx("option",{value:50,children:"50"}),t.jsx("option",{value:100,children:"100"}),t.jsx("option",{value:200,children:"200"})]}),t.jsxs("span",{className:"text-sm text-gray-400",children:["顯示 ",i+1,"-",Math.min(l,q.length)," / ",q.length]})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("button",{onClick:()=>Ee(1),disabled:L===1,className:`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${L===1?"bg-slate-700/50 text-gray-500 cursor-not-allowed opacity-50":"bg-slate-800/50 text-white hover:bg-purple-800/40 border border-purple-500/30"}`,children:"首頁"}),t.jsx("button",{onClick:()=>Ee(L-1),disabled:L===1,className:`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${L===1?"bg-slate-700/50 text-gray-500 cursor-not-allowed opacity-50":"bg-slate-800/50 text-white hover:bg-purple-800/40 border border-purple-500/30"}`,children:"上一頁"}),t.jsxs("span",{className:"px-3 py-1.5 text-sm text-gray-300",children:["第 ",L," / ",w," 頁"]}),t.jsx("button",{onClick:()=>Ee(L+1),disabled:L===w,className:`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${L===w?"bg-slate-700/50 text-gray-500 cursor-not-allowed opacity-50":"bg-slate-800/50 text-white hover:bg-purple-800/40 border border-purple-500/30"}`,children:"下一頁"}),t.jsx("button",{onClick:()=>Ee(w),disabled:L===w,className:`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${L===w?"bg-slate-700/50 text-gray-500 cursor-not-allowed opacity-50":"bg-slate-800/50 text-white hover:bg-purple-800/40 border border-purple-500/30"}`,children:"末頁"})]})]}),t.jsx(Ar,{items:c,onSelect:n=>{if(xt){const o=new URLSearchParams;G&&o.set("server",G);const R=o.toString(),$=`/item/${n.id}${R?"?"+R:""}`;xt(n),window.open($,"_blank")}},selectedItem:null,marketableItems:Dt,itemVelocities:ir,itemAveragePrices:cr,itemMinListings:dr,itemRecentPurchases:ur,itemTradability:Ct,isLoadingVelocities:Pe,averagePriceHeader:"平均價格",getSimplifiedChineseName:qr,addToast:K,selectedRarities:tt,setSelectedRarities:Rt,raritiesData:we,externalRarityFilter:!0,externalRarityCounts:M,isServerDataLoaded:ze,isRaritySelectorDisabled:!ze||Pe||ot||Nt||U}),q.length>ye&&t.jsxs("div",{className:"mt-4 flex items-center justify-between flex-wrap gap-3 bg-gradient-to-br from-slate-800/60 via-purple-900/20 to-slate-800/60 backdrop-blur-sm rounded-lg border border-purple-500/20 p-3",children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("label",{className:"text-sm text-gray-300",children:"每頁顯示:"}),t.jsxs("select",{value:ye,onChange:n=>{const o=parseInt(n.target.value,10);Ft(o),he(1)},className:"px-3 py-1.5 bg-slate-900/50 border border-purple-500/30 rounded-lg text-white text-sm focus:outline-none focus:border-ffxiv-gold",children:[t.jsx("option",{value:50,children:"50"}),t.jsx("option",{value:100,children:"100"}),t.jsx("option",{value:200,children:"200"})]}),t.jsxs("span",{className:"text-sm text-gray-400",children:["顯示 ",i+1,"-",Math.min(l,q.length)," / ",q.length]})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("button",{onClick:()=>Ee(1),disabled:L===1,className:`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${L===1?"bg-slate-700/50 text-gray-500 cursor-not-allowed opacity-50":"bg-slate-800/50 text-white hover:bg-purple-800/40 border border-purple-500/30"}`,children:"首頁"}),t.jsx("button",{onClick:()=>Ee(L-1),disabled:L===1,className:`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${L===1?"bg-slate-700/50 text-gray-500 cursor-not-allowed opacity-50":"bg-slate-800/50 text-white hover:bg-purple-800/40 border border-purple-500/30"}`,children:"上一頁"}),t.jsxs("span",{className:"px-3 py-1.5 text-sm text-gray-300",children:["第 ",L," / ",w," 頁"]}),t.jsx("button",{onClick:()=>Ee(L+1),disabled:L===w,className:`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${L===w?"bg-slate-700/50 text-gray-500 cursor-not-allowed opacity-50":"bg-slate-800/50 text-white hover:bg-purple-800/40 border border-purple-500/30"}`,children:"下一頁"}),t.jsx("button",{onClick:()=>Ee(w),disabled:L===w,className:`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${L===w?"bg-slate-700/50 text-gray-500 cursor-not-allowed opacity-50":"bg-slate-800/50 text-white hover:bg-purple-800/40 border border-purple-500/30"}`,children:"末頁"})]})]})]})})()]})}),t.jsx(Br,{isOpen:nr,onClose:()=>lr(!1),taxRates:sr,worlds:pt,isLoading:or,selectedWorld:O,selectedServerOption:G})]})}export{Zr as default};
