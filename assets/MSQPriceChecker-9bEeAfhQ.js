import{_ as Re,g as tt,a as rt}from"./services-data-DOFC0cEd.js";import{u as st,b as nt,a as it,r as s,j as t}from"./react-vendor-DmEpS5Kz.js";import{g as at,T as lt,a as ot,S as ct,b as ut,c as mt}from"./index-_u_x4PTc.js";import{a as dt}from"./axios-B9ygI19o.js";import{e as ae}from"./data-other-BAzrwk9S.js";import"./opencc-C1Qz6KEM.js";import"./data-tw-items-4ChDDRSh.js";import"./data-tw-descriptions-CJIEoqIq.js";import"./vendor-dPMYpV4t.js";const ft={MainHand:"主手武器",OffHand:"副手",Head:"頭部",Body:"身體",Gloves:"手套",Waist:"腰部",Legs:"腿部",Feet:"腳部",Ears:"耳環",Neck:"項鍊",Wrists:"手環",Rings:"戒指"};function wt({addToast:v,removeToast:Ce,toasts:ke,datacenters:Le,worlds:J,selectedWorld:g,onWorldChange:Ee,selectedServerOption:f,onServerOptionChange:_e,serverOptions:Me,isServerDataLoaded:k,onItemSelect:X,onSearch:Ve,searchText:Ae,setSearchText:F,isSearching:L,onTaxRatesClick:Fe,isTaxRatesModalOpen:$e,setIsTaxRatesModalOpen:De,taxRates:Te,isLoadingTaxRates:Ue}){const E=st(),[q,He]=nt(),$=it(),[p,le]=s.useState(""),[b,_]=s.useState(null),M=s.useRef(null),D=s.useRef(!1),Y=s.useRef(""),[P,T]=s.useState(null),[Z,ee]=s.useState([]),[Be,oe]=s.useState({}),[Oe,ce]=s.useState({}),[ze,ue]=s.useState({}),[Qe,me]=s.useState({}),[Ge,de]=s.useState({}),[fe,U]=s.useState(!1),[Ke,We]=s.useState(null),H=s.useRef(null),B=s.useRef(null),ge=s.useCallback(async()=>{if(B.current)return B.current;const e=await Re(()=>import("./data-other-BAzrwk9S.js").then(r=>r.o),[]);return B.current=e.default,B.current},[]),w=s.useCallback(async()=>{if(H.current)return H.current;const e=await Re(()=>import("./data-other-BAzrwk9S.js").then(r=>r.c),[]);return H.current=e.default,H.current},[]);s.useEffect(()=>{if(D.current)return;const e=`${$.pathname}?${$.search}`;if(Y.current===e)return;const r=q.get("ilvl"),c=q.get("category");if(r){const o=parseInt(r,10);!isNaN(o)&&o>=1&&o<=999&&(D.current=!0,le(r),w().then(n=>{const i=Object.entries(n).filter(([m,z])=>z===o);i.length>0&&_({valid:!0,message:`找到 ${i.length} 個物品`})}),T(c||null),Y.current=e)}else Y.current=e},[$.pathname,$.search,q,w]);const[pe,he]=s.useState(!1),O=s.useRef(null);s.useEffect(()=>{const e=q.get("ilvl");e&&D.current&&p===e&&b?.valid&&k&&(D.current=!1,he(!0))},[p,b,q,k]),s.useEffect(()=>{pe&&p&&b?.valid&&k&&O.current&&(he(!1),setTimeout(()=>{O.current&&O.current()},100))},[pe,p,b,k]);const te=s.useMemo(()=>{const e=new Map;Object.entries(ae).forEach(([c,o])=>{Object.entries(o).forEach(([n,i])=>{if(n!=="SoulCrystal"&&(i===1||i===-1)){const m=n==="FingerL"||n==="FingerR"?"Rings":n;e.has(m)||e.set(m,{name:m,translatedName:ft[m]||m})}})});const r=["MainHand","OffHand","Head","Body","Gloves","Legs","Feet","Ears","Neck","Wrists","Rings"];return Array.from(e.values()).sort((c,o)=>{const n=r.indexOf(c.name),i=r.indexOf(o.name);return n===-1?1:i===-1?-1:n-i})},[]),xe=s.useCallback((e,r,c)=>{if(!r)return!0;const o=c[e.toString()];if(!o||o.equipSlotCategory===void 0)return!1;const n=o.equipSlotCategory,i=ae[n.toString()];return i?r==="Rings"?i.FingerL===1||i.FingerL===-1||i.FingerR===1||i.FingerR===-1:r==="SoulCrystal"?!1:i[r]===1||i[r]===-1:!1},[]),ve=s.useCallback((e,r)=>{const c=r[e.toString()];if(!c||c.equipSlotCategory===void 0)return!1;const o=c.equipSlotCategory,n=ae[o.toString()];return n?te.some(i=>i.name==="Rings"?n.FingerL===1||n.FingerL===-1||n.FingerR===1||n.FingerR===-1:i.name==="SoulCrystal"?!1:n[i.name]===1||n[i.name]===-1):!1},[te]),Je=s.useCallback(e=>{le(e),M.current&&clearTimeout(M.current),M.current=setTimeout(async()=>{const r=parseInt(e,10);if(e===""){_(null);return}if(isNaN(r)||r<1||r>999){_({valid:!1,message:"請輸入1-999之間的數字"});return}const c=await w(),o=Object.entries(c).filter(([n,i])=>i===r);o.length===0?_({valid:!1,message:"此物品等級沒有物品"}):_({valid:!0,message:`找到 ${o.length} 個物品`})},1e3)},[w]);s.useEffect(()=>()=>{M.current&&clearTimeout(M.current)},[]);const re=s.useCallback(async()=>{if(L)return;const e=parseInt(p,10);if(isNaN(e)||e<1||e>999){v("請輸入有效的物品等級","error");return}const r=q.get("ilvl"),c=q.get("category");if(r!==p||c!==(P||"")){const n=new URLSearchParams;n.set("ilvl",p),P?n.set("category",P):n.delete("category"),E(`/msq-price-checker?${n.toString()}`,{replace:!0})}ee([]),oe({}),ce({}),ue({}),me({}),de({});try{const[n,i]=await Promise.all([w(),ge()]);let m=Object.entries(n).filter(([a,d])=>d===e).map(([a,d])=>parseInt(a,10));if(m.length===0){v("未找到該物品等級的物品","warning"),ee([]);return}if(P?m=m.filter(a=>xe(a,P,i)):m=m.filter(a=>ve(a,i)),m.length===0){v("該裝備分類中沒有相符的物品","warning");return}const z=await at();We(z);const Q=m.filter(a=>z.has(a));if(Q.length===0){v("沒有可交易的物品","warning");return}const Xe=Q.map(a=>tt(a)),be=(await Promise.all(Xe)).filter(a=>a!==null);if(be.length===0){v("無法獲取物品信息","error");return}const Ye=be.map(a=>{const d=i[a.id.toString()];return{...a,ilvl品級:e,需求等級:d?.level||0,equipSlotCategory:d?.equipSlotCategory,jobs:d?.jobs||[]}}).sort((a,d)=>a.需求等級!==d.需求等級?a.需求等級-d.需求等級:a.name.localeCompare(d.name));if(ee(Ye),U(!0),!g||!f){v("請選擇伺服器","warning"),U(!1);return}const V=f===g.section,Ze=V?g.section:f,ye=100,qe={},Pe={},we={},je={},j={};for(let a=0;a<Q.length;a+=ye){const d=Q.slice(a,a+ye),et=d.join(",");try{const I=(await dt.get(`https://universalis.app/api/v2/aggregated/${encodeURIComponent(Ze)}/${et}`)).data;I&&I.results&&I.results.forEach(l=>{const A=l.itemId,G=(h,x,u)=>{const y=h?.world?.[u],ie=x?.world?.[u],Ne=h?.dc?.[u],Se=x?.dc?.[u],R=V?Ne!==void 0?Ne:y:y!==void 0?y:void 0,C=V?Se!==void 0?Se:ie:ie!==void 0?ie:void 0;if(u==="quantity"){if(R!==void 0||C!==void 0)return(R||0)+(C||0)}else{if(R!==void 0&&C!==void 0)return Math.min(R,C);if(C!==void 0)return C;if(R!==void 0)return R}return null},se=G(l.nq?.dailySaleVelocity,l.hq?.dailySaleVelocity,"quantity"),ne=G(l.nq?.averageSalePrice,l.hq?.averageSalePrice,"price"),K=G(l.nq?.minListing,l.hq?.minListing,"price"),W=G(l.nq?.recentPurchase,l.hq?.recentPurchase,"price");let N=null;if(K!=null)if(V)N=K;else{const h=l.nq?.minListing?.world?.price,x=l.hq?.minListing?.world?.price;let u=null;h!==void 0&&x!==void 0?u=x<=h?l.hq?.minListing?.world:l.nq?.minListing?.world:x!==void 0?u=l.hq?.minListing?.world:h!==void 0&&(u=l.nq?.minListing?.world);const y=u?.region;N={price:K},y!==void 0&&(N.region=y)}let S=null;if(W!=null)if(V)S=W;else{const h=l.nq?.recentPurchase?.world?.price,x=l.hq?.recentPurchase?.world?.price;let u=null;h!==void 0&&x!==void 0?u=x<=h?l.hq?.recentPurchase?.world:l.nq?.recentPurchase?.world:x!==void 0?u=l.hq?.recentPurchase?.world:h!==void 0&&(u=l.nq?.recentPurchase?.world);const y=u?.region;S={price:W},y!==void 0&&(S.region=y)}se!=null&&(qe[A]=se),ne!=null&&(Pe[A]=Math.round(ne)),N!=null&&(we[A]=N),S!=null&&(je[A]=S),j[A]=!0}),d.forEach(l=>{j.hasOwnProperty(l)||(j[l]=!1)})}catch(Ie){console.error("Error fetching market data:",Ie),d.forEach(I=>{j.hasOwnProperty(I)||(j[I]=!1)})}}oe(qe),ce(Pe),ue(we),me(je),de(j),U(!1)}catch(n){console.error("Search error:",n),v("搜索失敗，請稍後再試","error"),U(!1)}},[p,P,g,f,v,xe,ve,q,He,w,ge]);return s.useEffect(()=>{O.current=re},[re]),t.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-slate-950 via-slate-900 via-purple-950/30 to-slate-950 text-white",children:[t.jsx(lt,{onSearch:Ve,isSearching:L,searchText:Ae,setSearchText:F,isServerDataLoaded:k,selectedDcName:g?.section,onItemSelect:X,showNavigationButtons:!0,activePage:"msq-price-checker",onTaxRatesClick:Fe,onMSQPriceCheckerClick:()=>{F(""),E("/msq-price-checker")},onUltimatePriceKingClick:()=>{F(""),E("/ultimate-price-king")},onAdvancedSearchClick:()=>{F(""),E("/advanced-search")}}),t.jsx("div",{className:"fixed right-2 mid:right-4 left-2 mid:left-auto z-50 space-y-2 max-w-sm mid:max-w-none top-[60px] mid:top-4",children:ke.map(e=>t.jsx(ot,{message:e.message,type:e.type,onClose:()=>Ce(e.id)},e.id))}),t.jsx("div",{className:"pt-24 pb-8",children:t.jsxs("div",{className:"max-w-7xl mx-auto px-4",children:[t.jsxs("div",{className:"mb-6",children:[t.jsx("h1",{className:"text-3xl sm:text-4xl font-bold text-ffxiv-gold mb-2",children:"主線裝備查價"}),t.jsx("p",{className:"text-gray-400 text-sm sm:text-base",children:"主線拿到的箱子可以快速查看市場價格。"})]}),t.jsxs("div",{className:"bg-gradient-to-br from-slate-800/60 via-purple-900/20 to-slate-800/60 backdrop-blur-sm rounded-lg border border-purple-500/20 p-4 sm:p-6 mb-6",children:[t.jsxs("div",{className:"mb-6",children:[t.jsx("label",{className:"block text-sm font-semibold text-ffxiv-gold mb-2",children:"物品等級 (ilvl品級)"}),t.jsx("div",{className:"flex items-end gap-3",children:t.jsxs("div",{className:"flex-1",children:[t.jsx("input",{type:"number",inputMode:"numeric",value:p,onChange:e=>Je(e.target.value),placeholder:"輸入物品等級...",className:"w-full px-3 py-2 bg-slate-900/50 border border-purple-500/30 rounded-lg text-white focus:outline-none focus:border-ffxiv-gold",min:"1",max:"999"}),b&&t.jsx("div",{className:`mt-2 text-xs ${b.valid?"text-green-400":"text-yellow-400"}`,children:b.message})]})})]}),t.jsxs("div",{className:"mb-6",children:[t.jsx("label",{className:"block text-sm font-semibold text-ffxiv-gold mb-2",children:"裝備分類 (可選)"}),t.jsxs("div",{className:"flex flex-wrap gap-2 max-h-48 overflow-y-auto p-2 bg-slate-900/30 rounded-lg border border-purple-500/20",children:[t.jsx("button",{onClick:()=>T(null),className:`px-3 py-1.5 rounded-lg text-xs sm:text-sm font-medium transition-all ${P===null?"bg-ffxiv-gold text-slate-900 border-2 border-ffxiv-gold":"bg-slate-800/50 text-gray-300 border border-purple-500/30 hover:bg-purple-800/40 hover:border-purple-400/50"}`,children:"全部分類"}),te.map(e=>{const r=P===e.name;return t.jsx("button",{onClick:()=>T(e.name),className:`px-3 py-1.5 rounded-lg text-xs sm:text-sm font-medium transition-all ${r?"bg-ffxiv-gold text-slate-900 border-2 border-ffxiv-gold":"bg-slate-800/50 text-gray-300 border border-purple-500/30 hover:bg-purple-800/40 hover:border-purple-400/50"}`,children:e.translatedName},e.name)})]})]}),g&&t.jsxs("div",{className:"mb-6",children:[t.jsx("label",{className:"block text-sm font-semibold text-ffxiv-gold mb-2",children:"伺服器選擇"}),t.jsx(ct,{datacenters:Le,worlds:J,selectedWorld:g,onWorldChange:Ee,selectedServerOption:f,onServerOptionChange:_e,serverOptions:Me,disabled:fe})]}),t.jsx("button",{onClick:re,disabled:L||!p||!b?.valid,className:`w-full py-3 rounded-lg font-semibold transition-all ${L||!p||!b?.valid?"bg-slate-700/50 text-gray-500 cursor-not-allowed opacity-50":"bg-gradient-to-r from-ffxiv-gold to-yellow-500 text-slate-900 hover:shadow-[0_0_20px_rgba(212,175,55,0.5)]"}`,children:L?"搜索中...":"搜索"})]}),Z.length>0&&t.jsxs("div",{className:"mb-6",children:[t.jsxs("div",{className:"flex items-center gap-3 mb-4 flex-wrap",children:[t.jsxs("h2",{className:"text-xl sm:text-2xl font-bold text-ffxiv-gold",children:["搜索結果 (",Z.length," 個物品)"]}),g&&f&&t.jsxs("div",{className:"flex items-center gap-2 px-3 py-1.5 bg-gradient-to-r from-purple-900/40 via-pink-900/30 to-indigo-900/40 border border-purple-500/30 rounded-lg backdrop-blur-sm",children:[t.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-ffxiv-gold animate-pulse"}),t.jsx("span",{className:"text-xs sm:text-sm font-semibold text-ffxiv-gold",children:f===g.section?`${g.section} (全服)`:J[f]||`伺服器 ${f}`})]})]}),t.jsx(ut,{items:Z,onSelect:e=>{if(X){const r=new URLSearchParams;f&&r.set("server",f);const c=r.toString(),o=`/item/${e.id}${c?"?"+c:""}`;X(e),requestAnimationFrame(()=>{requestAnimationFrame(()=>{E(o,{replace:!0})})})}},selectedItem:null,marketableItems:Ke,itemVelocities:Be,itemAveragePrices:Oe,itemMinListings:ze,itemRecentPurchases:Qe,itemTradability:Ge,isLoadingVelocities:fe,averagePriceHeader:"平均價格",getSimplifiedChineseName:rt,addToast:v})]})]})}),t.jsx(mt,{isOpen:$e,onClose:()=>De(!1),taxRates:Te,worlds:J,isLoading:Ue,selectedWorld:g,selectedServerOption:f})]})}export{wt as default};
