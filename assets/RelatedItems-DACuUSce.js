import{r as g,j as e}from"./react-vendor-DmEpS5Kz.js";import{f as W,g as k}from"./services-data-DOFC0cEd.js";import{g as E}from"./internalUrl-BGvhBhUH.js";import{l as I,D as L}from"./extractsService-D72l7IXV.js";import{I as O}from"./index-_u_x4PTc.js";import"./vendor-dPMYpV4t.js";import"./opencc-C1Qz6KEM.js";import"./data-tw-items-4ChDDRSh.js";import"./data-tw-descriptions-CJIEoqIq.js";import"./axios-B9ygI19o.js";async function P(i){if(!i||i<=0)return[];try{const d=await I(),h=new Set;return Object.keys(d).forEach(l=>{const u=d[l];if(!u||!u.sources)return;const s=u.sources.find(a=>a.type===2);!s||!s.data||!Array.isArray(s.data)||s.data.forEach(a=>{!a.trades||!Array.isArray(a.trades)||a.trades.forEach(o=>{o.currencies&&Array.isArray(o.currencies)&&o.currencies.some(x=>x.id===i)&&o.items&&Array.isArray(o.items)&&o.items.forEach(x=>{x.id&&h.add(x.id)})})})}),Array.from(h)}catch(d){return console.error("Failed to find exchangeable items:",d),[]}}async function T(i){if(!i||i<=0)return[];try{const d=await I(),h=new Set;return Object.keys(d).forEach(l=>{const u=d[l];if(!u||!u.sources)return;const s=u.sources.find(o=>o.type===L.DESYNTHS);s&&s.data&&Array.isArray(s.data)&&s.data.includes(i)&&h.add(parseInt(l));const a=u.sources.find(o=>o.type===L.REDUCED_FROM);a&&a.data&&Array.isArray(a.data)&&a.data.includes(i)&&h.add(parseInt(l))}),Array.from(h)}catch(d){return console.error("Failed to find desynthable items:",d),[]}}function X({itemId:i,onItemClick:d,onCollapse:h}){const[l,u]=g.useState([]),[s,a]=g.useState([]),[o,y]=g.useState(new Map),[x,b]=g.useState(!1),[v,w]=g.useState(30);return g.useEffect(()=>{if(!i){u([]),a([]),y(new Map);return}b(!0),Promise.all([W(i),P(i),T(i)]).then(([r,c,p])=>{const t=new Map;r.forEach(n=>{t.has(n)||t.set(n,new Set),t.get(n).add("crafted")}),c.forEach(n=>{t.has(n)||t.set(n,new Set),t.get(n).add("exchanged")}),p.forEach(n=>{t.has(n)||t.set(n,new Set),t.get(n).add("desynthed")});const f=new Set([...r,...c,...p]);u(Array.from(f)),y(t),b(!1)}).catch(r=>{console.error("Failed to find related items:",r),u([]),y(new Map),b(!1)})},[i]),g.useEffect(()=>{if(l.length===0){a([]),w(30);return}Promise.all(l.map(async r=>{try{const c=await k(r);if(!c)return null;const p=c.itemLevel||"",t=p?parseInt(p,10):0,f=isNaN(t)?0:t;return{id:r,name:c.name,itemLevel:f}}catch(c){return console.error(`Failed to load item ${r}:`,c),null}})).then(r=>{const p=r.filter(t=>t!==null).sort((t,f)=>{const n=o.get(t.id)||new Set,m=o.get(f.id)||new Set,j=n.has("exchanged"),C=m.has("exchanged"),D=n.has("desynthed"),M=m.has("desynthed"),B=n.has("crafted"),F=m.has("crafted"),N=(R,$,U)=>R?0:$?1:U?2:3,S=N(j,D,B),A=N(C,M,F);return S!==A?S-A:f.itemLevel!==t.itemLevel?f.itemLevel-t.itemLevel:t.name.localeCompare(f.name,"zh-TW")});a(p),w(30)}).catch(r=>{console.error("Failed to load related items:",r),a([])})},[l,o]),!x&&l.length===0?null:e.jsxs("div",{className:"bg-gradient-to-br from-slate-800/60 via-purple-900/20 to-slate-800/60 backdrop-blur-sm rounded-lg border border-purple-500/20 p-4",children:[e.jsx("div",{className:"flex items-center justify-between mb-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("h3",{className:"text-base sm:text-lg font-semibold text-ffxiv-gold flex items-center gap-2",children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"})}),"相關物品"]}),!x&&l.length>0&&e.jsxs("span",{className:"text-xs text-gray-400 bg-purple-900/40 px-2 py-1 rounded border border-purple-500/30",children:[l.length," 個"]})]})}),x&&e.jsxs("div",{className:"text-center py-4 text-gray-400",children:[e.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-ffxiv-gold mx-auto mb-2"}),e.jsx("span",{className:"text-sm",children:"載入中..."})]}),!x&&s.length>0&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"grid grid-cols-3 gap-2",children:s.slice(0,v).map(r=>{const c=o.get(r.id)||new Set,p=c.has("crafted"),t=c.has("exchanged"),f=c.has("desynthed");return e.jsxs("button",{onClick:n=>{if(n.preventDefault(),d)k(r.id).then(m=>{if(m)d(m);else{const j=`${window.location.origin}${E(`/item/${r.id}`)}`;window.open(j,"_blank","noopener,noreferrer")}});else{const m=`${window.location.origin}${E(`/item/${r.id}`)}`;window.open(m,"_blank","noopener,noreferrer")}},className:"flex flex-col items-center gap-1.5 p-2 rounded-lg bg-slate-800/60 border border-purple-500/30 hover:border-ffxiv-gold/60 hover:bg-slate-700/70 transition-all duration-200 group relative",children:[e.jsx(O,{itemId:r.id,alt:r.name,className:"w-10 h-10 object-contain rounded border border-purple-500/30 group-hover:border-ffxiv-gold/60 transition-colors duration-200"}),e.jsxs("div",{className:"flex flex-wrap gap-1 justify-center items-center",children:[p&&e.jsx("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-blue-900/60 border border-blue-500/40 text-blue-300 font-medium",children:"製作"}),t&&e.jsx("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-green-900/60 border border-green-500/40 text-green-300 font-medium",children:"兌換"}),f&&e.jsx("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-orange-900/60 border border-orange-500/40 text-orange-300 font-medium",children:"分解獲得"})]}),e.jsx("span",{className:"text-xs text-gray-300 group-hover:text-ffxiv-gold text-center line-clamp-2 transition-colors duration-200",title:r.name,children:r.name})]},r.id)})}),s.length>0&&e.jsxs("div",{className:"flex justify-center gap-3 mt-4",children:[h&&e.jsxs("button",{onClick:()=>{h&&h()},className:"px-4 py-2 bg-slate-800/60 hover:bg-slate-700/80 border border-slate-600/40 hover:border-slate-500/60 text-gray-300 hover:text-gray-200 rounded-lg transition-all duration-200 flex items-center gap-2",children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 15l7-7 7 7"})}),e.jsx("span",{children:"關閉相關物品"})]}),v<s.length&&e.jsxs("button",{onClick:()=>w(r=>Math.min(r+50,s.length)),className:"px-4 py-2 bg-purple-900/50 hover:bg-purple-800/70 border border-purple-500/40 hover:border-purple-400/60 text-purple-200 hover:text-ffxiv-gold rounded-lg transition-all duration-200 flex items-center gap-2",children:[e.jsx("span",{children:"顯示更多"}),e.jsxs("span",{className:"text-xs text-gray-400",children:["(",v," / ",s.length,")"]}),e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})]})]})]}),!x&&s.length===0&&l.length>0&&e.jsx("div",{className:"text-center py-4 text-gray-400 text-sm",children:"載入物品資訊中..."})]})}export{X as default};
